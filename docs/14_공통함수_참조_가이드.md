# 공통함수 참조 가이드

## 문서 정보
- **작성일**: 2025-01-17
- **버전**: v2.0
- **목적**: SourceAnalyzer의 통합 공통함수에 대한 상세 참조 가이드

## 1. 개요 (연관관계 도출 중심)

SourceAnalyzer는 **연관관계 도출 중심**의 설계 원칙을 따릅니다. 
완벽한 파싱보다 관계 추출을 우선하며, 안전한 Fallback 메커니즘을 통해 안정성을 확보합니다.

### 1.1 주요 개선사항 (연관관계 중심)
- **연관관계 우선**: 완벽한 파싱보다 관계 추출 우선
- **즉시 관계 생성**: 파싱과 동시에 관계 도출
- **안전한 Fallback**: 고급 파싱 실패 시 기본 파싱으로 대체
- **점진적 관계 완성**: 파일별로 관계를 점진적으로 완성
- **80/20 원칙**: 80% 일반적 케이스의 안정적 지원

### 1.2 공통함수 구조
```
SourceAnalyzer/util/
├── __init__.py          # 통합 임포트
├── logger.py            # 로깅 시스템 (파일명:라인번호 포함)
├── database_utils.py    # DB 처리 (건건 커밋)
├── file_utils.py        # 파일 처리 (다중 인코딩 지원)
├── hash_utils.py        # 해시 생성 및 변경감지
├── path_utils.py        # 크로스플랫폼 경로 처리
├── config_utils.py      # YAML 설정 파일 처리
├── validation_utils.py  # 유효성 검사
└── arg_utils.py         # 명령행 인수 처리
```

## 2. 로깅 시스템 (`util/logger.py`)

### 2.1 기본 로깅 사용법

```python
from util.logger import app_logger, debug, info, warning, error, critical, handle_error

# 기본 로깅 (파일명:라인번호 자동 포함)
app_logger.info("분석 시작")
app_logger.debug("디버그 정보")
app_logger.warning("경고 메시지")
app_logger.error("에러 메시지")

# 편의 함수 사용
info("정보 메시지")
debug("디버그 메시지")
warning("경고 메시지")
error("에러 메시지")
critical("치명적 에러")

# 에러 발생 시 프로그램 종료
try:
    risky_operation()
except Exception as e:
    handle_error(e, "작업 실패")
```

### 2.2 로그 포맷
- **포맷**: `%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s`
- **예시**: `2025-01-17 15:30:45 - SourceAnalyzer - INFO - main.py:123 - 분석 시작`

## 3. 데이터베이스 처리 (`util/database_utils.py`)

### 3.1 기본 DB 연결 및 쿼리 실행

```python
from util.database_utils import DatabaseUtils, create_database_connection

# DB 연결 생성
db_utils = create_database_connection("projects/SampleSrc/metadata.db")

# SELECT 쿼리 실행
results = db_utils.execute_query("SELECT * FROM projects WHERE project_name = ?", ("SampleSrc",))

# INSERT/UPDATE/DELETE 쿼리 실행 (건건 커밋)
affected_rows = db_utils.execute_update("INSERT INTO files (file_path) VALUES (?)", ("test.java",))

# 레코드 삽입
success = db_utils.insert_record("files", {
    "file_path": "test.java",
    "file_type": "java",
    "line_count": 100
})

# 레코드 업데이트
success = db_utils.update_record("files", 
    {"line_count": 150}, 
    {"file_path": "test.java"}
)

# 레코드 삭제
success = db_utils.delete_record("files", {"file_path": "test.java"})
```

### 3.2 스키마 생성

```python
# SQL 스키마 파일로부터 데이터베이스 생성
success = db_utils.create_schema("database/create_table_script.sql")
```

## 4. 파일 처리 (`util/file_utils.py`)

### 4.1 다중 인코딩 지원 파일 읽기/쓰기

```python
from util.file_utils import FileUtils, read_file, write_file

# 파일 읽기 (자동 인코딩 감지: utf-8 → utf-8-sig → cp949 → euc-kr)
content = read_file("projects/SampleSrc/config/target_source_config.yaml")

# 파일 쓰기
success = write_file("output/report.html", html_content, encoding='utf-8')

# 파일 정보 조회
file_info = FileUtils.get_file_info("test.java")
# 결과: {
#   'exists': True,
#   'size': 1024,
#   'modified_time': 'Mon Jan 17 15:30:45 2025',
#   'file_type': 'java',
#   'hash_md5': 'abc123...',
#   'hash_sha256': 'def456...'
# }
```

### 4.2 파일 타입 감지 및 목록 조회

```python
# 파일 타입 감지
file_type = FileUtils.get_file_type("UserController.java")  # 'java'
file_type = FileUtils.get_file_type("index.vue")           # 'vue'
file_type = FileUtils.get_file_type("App.jsx")             # 'jsx'

# 지원 파일 목록 조회
java_files = FileUtils.list_files("src", "*.java", recursive=True)
all_files = FileUtils.list_files("projects/SampleSrc", "*", recursive=True)

# 지원 파일 여부 확인
is_supported = FileUtils.is_supported_file("test.java")  # True
```

## 5. 해시 처리 (`util/hash_utils.py`)

### 5.1 해시 생성 및 변경감지

```python
from util.hash_utils import HashUtils, generate_md5, generate_file_hash

# 문자열 해시 생성
md5_hash = generate_md5("Hello World")  # 'b10a8db164e0754105b7a99be72e3fe5'
sha256_hash = HashUtils.generate_sha256("Hello World")

# 파일 해시 생성
file_hash = generate_file_hash("test.java", algorithm='md5')
file_hash_sha256 = HashUtils.generate_file_hash("test.java", algorithm='sha256')

# 파일 변경감지
is_changed = HashUtils.is_file_changed("test.java", previous_hash, algorithm='md5')

# 내용 해시 생성
content_hash = HashUtils.get_content_hash("file content", algorithm='md5')
```

## 6. 경로 처리 (`util/path_utils.py`)

### 6.1 기본 경로 처리

```python
from util.path_utils import PathUtils, normalize_path, join_path

path_utils = PathUtils()

# 경로 정규화
normalized = normalize_path("projects/SampleSrc/config")
# 결과: "D:\Analyzer\SourceAnalyzer\projects\SampleSrc\config"

# 경로 결합
combined = join_path("projects", "SampleSrc", "config", "target_source_config.yaml")

# 파일명/디렉토리명 추출
filename = path_utils.get_filename("/path/to/file.java")  # 'file.java'
dirname = path_utils.get_dirname("/path/to/file.java")    # '/path/to'
extension = path_utils.get_extension("file.java")         # '.java'
stem = path_utils.get_file_stem("file.java")              # 'file'
```

### 6.2 프로젝트 경로 관리

```python
# 프로젝트별 경로 생성
source_path = get_project_source_path("SampleSrc")
config_path = get_project_config_path("SampleSrc")
db_schema_path = get_project_db_schema_path("SampleSrc")
report_path = get_project_report_path("SampleSrc")
metadata_db_path = get_project_metadata_db_path("SampleSrc")

# 설정 파일 경로
config_dir = get_config_path()
db_schema_file = get_database_schema_path()
parser_config_dir = get_parser_config_path()

# 프로젝트 관리
project_list = list_projects()  # ['SampleSrc', 'AnotherProject']
exists = project_exists("SampleSrc")  # True

# 크로스플랫폼 경로 정규화 (Unix 스타일로 통일)
normalized_path = normalize_path_separator("src\\main\\java\\com\\example", 'unix')
# 결과: "src/main/java/com/example"

# Windows 스타일로 변환 (필요시)
windows_path = convert_to_windows_path("src/main/java/com/example")
# 결과: "src\main\java\com\example"
```

## 7. 설정 처리 (`util/config_utils.py`)

### 7.1 YAML 설정 파일 처리

```python
from util.config_utils import ConfigUtils, load_yaml_config, get_config_value

config_utils = ConfigUtils()

# 설정 파일 로드
config = load_yaml_config("config/config.yaml")

# 설정 값 조회 (점 표기법 지원)
db_host = get_config_value(config, "database.host", "localhost")
parser_enabled = get_config_value(config, "parser.java.enabled", True)

# 프로젝트별 설정 로드
project_config = config_utils.load_project_config("SampleSrc")

# 메인 설정 로드
main_config = config_utils.get_main_config()
logging_config = config_utils.get_logging_config()

# 파서별 설정 로드
java_config = config_utils.get_parser_config("java")
vue_config = config_utils.get_parser_config("vue")
```

### 7.2 설정 유효성 검사

```python
# 필수 키 검증
required_keys = ["database.host", "parser.java.enabled"]
is_valid = config_utils.validate_config(config, required_keys)

# 설정 캐시 관리
config_utils.clear_cache()
reloaded_config = config_utils.reload_config("config/config.yaml")
```

## 8. 유효성 검사 (`util/validation_utils.py`)

### 8.1 기본 유효성 검사

```python
from util.validation_utils import ValidationUtils, is_valid_project_name, validate_file_exists

# 프로젝트명 검증
is_valid = is_valid_project_name("SampleSrc")  # True
is_valid = is_valid_project_name("Invalid Name!")  # False

# 파일 경로 검증
is_valid_path = ValidationUtils.is_valid_file_path("/path/to/file.java")  # True
file_exists = validate_file_exists("/path/to/file.java")  # True

# 디렉토리 존재 여부 검증
dir_exists = ValidationUtils.validate_directory_exists("/path/to/directory")

# 파일 확장자 검증
allowed_extensions = ['.java', '.xml', '.vue']
is_valid_ext = ValidationUtils.validate_file_extension("test.java", allowed_extensions)  # True
```

### 8.2 데이터 유효성 검사

```python
# 필수 필드 검증
data = {"name": "test", "type": "java"}
required_fields = ["name", "type", "path"]
result = ValidationUtils.validate_required_fields(data, required_fields)
# 결과: {
#   'is_valid': False,
#   'missing_fields': ['path'],
#   'errors': ['필수 필드 누락: [\'path\']']
# }

# 프로젝트 구조 검증
structure_result = ValidationUtils.validate_project_structure("SampleSrc")
# 결과: {
#   'is_valid': True,
#   'missing_directories': [],
#   'missing_files': [],
#   'errors': []
# }
```

## 9. 명령행 인수 처리 (`util/arg_utils.py`)

### 9.1 기본 인수 파싱

```python
from util.arg_utils import ArgUtils, parse_command_line_args, validate_and_get_project_name

# 명령행 인수 파싱
args = parse_command_line_args()
# 결과: Namespace(project_name='SampleSrc', clear_metadb=False, dry_run=False, verbose=False)

# 프로젝트명 추출 및 검증
project_name = validate_and_get_project_name()  # 'SampleSrc'

# 플래그 확인
if ArgUtils.has_flag(args, 'clear_metadb'):
    print("메타데이터베이스 초기화")

# 옵션 값 조회
output_dir = ArgUtils.get_option_value(args, 'output_dir', 'default_output')
verbose = ArgUtils.get_option_value(args, 'verbose', False)
```

### 9.2 사용법 출력

```python
# 도움말 출력 후 프로그램 종료
ArgUtils.print_usage_and_exit(0)  # 정상 종료
ArgUtils.print_usage_and_exit(1)  # 에러 종료
```

## 10. 통합 사용 예시

### 10.1 프로젝트 분석 시작

```python
from util import (
    app_logger, handle_error,
    validate_and_get_project_name,
    ConfigUtils, PathUtils, DatabaseUtils,
    FileUtils, ValidationUtils
)

def main():
    try:
        # 1. 프로젝트명 검증
        project_name = validate_and_get_project_name()
        if not project_name:
            app_logger.error("유효한 프로젝트명이 필요합니다")
            return
        
        # 2. 프로젝트 구조 검증
        path_utils = PathUtils()
        structure_result = ValidationUtils.validate_project_structure(project_name)
        if not structure_result['is_valid']:
            app_logger.error(f"프로젝트 구조 오류: {structure_result['errors']}")
            return
        
        # 3. 설정 로드
        config_utils = ConfigUtils()
        project_config = config_utils.load_project_config(project_name)
        
        # 4. 데이터베이스 연결
        metadata_db_path = get_project_metadata_db_path(project_name)
        db_utils = DatabaseUtils(metadata_db_path)
        if not db_utils.connect():
            app_logger.error("데이터베이스 연결 실패")
            return
        
        # 5. 파일 스캔
        source_path = get_project_source_path(project_name)
        all_files = FileUtils.list_files(source_path, "*", recursive=True)
        
        app_logger.info(f"프로젝트 분석 시작: {project_name}, 파일 수: {len(all_files)}")
        
        # 6. 파일별 분석 처리
        for file_path in all_files:
            if FileUtils.is_supported_file(file_path):
                file_type = FileUtils.get_file_type(file_path)
                app_logger.debug(f"분석 중: {file_path} ({file_type})")
                
                # 파일 분석 로직...
        
        app_logger.info("프로젝트 분석 완료")
        
    except Exception as e:
        handle_error(e, "프로젝트 분석 실패")

if __name__ == "__main__":
    main()
```

### 10.2 설정 기반 파일 처리

```python
from util import ConfigUtils, FileUtils, PathUtils

def process_project_files(project_name: str):
    # 설정 로드
    config_utils = ConfigUtils()
    project_config = config_utils.load_project_config(project_name)
    
    # 파일 타입별 설정 가져오기
    file_types = config_utils.get_config_value(project_config, "file_types", {})
    
    path_utils = PathUtils()
    source_path = get_project_source_path(project_name)
    
    for file_type, extensions in file_types.items():
        if file_type == 'java':
            java_files = FileUtils.list_files(source_path, "*.java", recursive=True)
            for java_file in java_files:
                # Java 파일 처리
                content = FileUtils.read_file(java_file)
                file_hash = FileUtils.get_file_hash(java_file)
                # ... 분석 로직
```

## 11. 주의사항 및 베스트 프랙티스

### 11.1 에러 처리
- 모든 공통함수는 `handle_error()`를 사용하여 일관된 에러 처리
- 예외 발생 시 프로그램이 안전하게 종료됨
- 로그 파일에 상세한 에러 정보 기록

### 11.2 성능 고려사항
- DB 트랜잭션은 건건 커밋으로 단순화 (성능보다 안정성 우선)
- 파일 해시는 필요할 때만 계산
- 설정 파일은 캐시를 통해 중복 로드 방지

### 11.3 크로스플랫폼 지원
- 모든 경로 처리는 `PathUtils` 사용
- 파일 인코딩은 자동 감지 및 재시도
- Windows/RHEL 환경 모두 지원

### 11.4 확장성
- 새로운 파일 타입은 `FileUtils.SUPPORTED_EXTENSIONS`에 추가
- 새로운 설정은 YAML 파일로 관리
- 플러그인 아키텍처와 연동 가능

이 가이드를 참조하여 SourceAnalyzer의 모든 공통함수를 효과적으로 활용하시기 바랍니다.
