<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  순환 참조 테스트용 MyBatis 매퍼
  Enhanced 파싱 기능 테스트: 순환 참조 탐지 및 처리
-->
<mapper namespace="com.example.testcase.TestCircularIncludeMapper">

    <!-- 
    순환 참조 테스트 1: A -> B -> A
    -->
    <sql id="fragmentA">
        SELECT u.user_id, u.username
        FROM users u
        <include refid="fragmentB"/>
    </sql>
    
    <sql id="fragmentB">
        LEFT JOIN user_profiles up ON u.user_id = up.user_id
        <include refid="fragmentA"/>
    </sql>
    
    <!-- 
    순환 참조 사용 쿼리 - 순환 참조 탐지 테스트
    예상 결과: 순환 참조 경고 후 부분 처리 또는 Fallback
    -->
    <select id="testCircularReference" resultType="map">
        <include refid="fragmentA"/>
        WHERE u.status = 'ACTIVE'
    </select>
    
    <!-- 
    순환 참조 테스트 2: A -> B -> C -> A (3단계 순환)
    -->
    <sql id="fragmentX">
        SELECT u.user_id
        <include refid="fragmentY"/>
    </sql>
    
    <sql id="fragmentY">
        , o.order_date
        <include refid="fragmentZ"/>
    </sql>
    
    <sql id="fragmentZ">
        , p.product_name
        FROM users u
        LEFT JOIN orders o ON u.user_id = o.user_id
        LEFT JOIN products p ON o.product_id = p.product_id
        <include refid="fragmentX"/>
    </sql>
    
    <!-- 
    3단계 순환 참조 사용 쿼리
    -->
    <select id="testDeepCircularReference" resultType="map">
        <include refid="fragmentX"/>
        WHERE u.status = 'ACTIVE'
    </select>
    
    <!-- 
    정상 include 테스트 (순환 없음)
    -->
    <sql id="normalFragment">
        LEFT JOIN categories c ON p.category_id = c.category_id
    </sql>
    
    <select id="testNormalInclude" resultType="map">
        SELECT u.user_id, u.username, p.product_name, c.category_name
        FROM users u
        LEFT JOIN orders o ON u.user_id = o.user_id
        LEFT JOIN products p ON o.product_id = p.product_id
        <include refid="normalFragment"/>
        WHERE u.status = 'ACTIVE'
    </select>

</mapper>
